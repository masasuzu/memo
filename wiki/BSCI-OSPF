! BSCI-OSPF 

{{toc}}

!! リンクステートルーティングプロトコルの特徴
* リンクの詳細な状態を交換し、LSDBに格納
* SPFアルゴリズムによる最適パスの計算
* ルーティングテーブルのコンバージェンスが速い
* Helloによる定期的なキープアライブ
* トポロジの変化に必要な部分のみのトリガードアップデート
* クラスレスルーティングプロトコル
* メモリやCPUの使用率が高い 

!! OSPFのパケットタイプ
||! タイプ || 名前  || 役割 ||
|| 1       || Hello || ネイバーを検出し、隣接関係確立する                                     ||
|| 2       || DBD   || 隣接関係の確立後、LSDBjの動機をチェックする                            ||
|| 3       || LSR   || 特定のリンクステート情報を要求する                                     ||
|| 4       || LSU   || LSRに応答して送信するリンクステート情報。LSU内に1つ以上のLSAが含まれる ||
|| 5       || LSAck || Helloを除くパケットの確認応答                                          ||

!! Helloパケット
!!! ネイバー確立のために一致の必要あり
* ネットワークマスク
* Hello/Deadの間隔
* エリアID
* 認証データ
* スタブエリアフラグ

!!! ネイバー確立のために一致の必要なし
* ルータID
* ネイバー情報
* ルータプライオリティ
* DR/BDRのIPアドレス



!! ルータの種類
||! 種類                            ||! 概要                                                ||
|| 内部ルータ                       || 全インターフェースが同一エリア内に収まっているルータ ||
|| バックボーンルータ               || エリア0に接続するインターフェースを持っているルータ  ||
|| エリアボーダルータ（ABR)         || インターフェースが複数のエリアにまたがっているルータ ||
|| 自律システムボーダルータ（ASBR） || 外部ASと接続されたインターフェースを持っているルータ ||

!! ルータの状態
: DOWN :
:: Helloを受け取っていない最初の状態 
: INIT:
:: Helloパケットを受信し、相手を認識 
: 2WAY:
:: お互いに認識した状態
: EXSTART:
:: DR、BDR決定
: EXCHANGE:
:: データベースの交換 
: LOADING:
:: 詳細情報確認 
: FULL:
:: コンバージェンス

!! LSAのタイプ
: ルータリンク(1):
:: ルータのリンク数、ルータのタイプやIPアドレス、コストなどの情報が含まれる
: ネットワークリンク(2):
:: マルチアクセスネットワークに接続されたルータがリストされる
: 集約リンク(3):
:: エリア内のネットワーク情報をABRが集約し、ほかのエリアに通知する。つまり外部エリアで生成されたエントリ
: ASBR集約リンク(4):
:: エリア内にASBRが配置されているとき、ASBRを通知するために使用する。
: AS外部リンク(5):
:: 外部ASのルート情報をOSPFドメイン内に通知するために使用する
: NSSAリンク(7):
:: NSLSASエリアのみでフラッディングされ、ABRにおいてタイプ5LSAに変換し、OSPFドメイン内に通知する。

||! タイプ ||! 名前              ||! 表示 ||! 生成ルータ  ||! フラッディングエリア                        ||
||  1      || ルータリンク       || O     || 全ルータ     || 生成エリア内                                 ||
||  2      || ネットワークリンク || O     || DR           || 生成エリア内                                 ||
||  3      || 集約リンク         || O IA  || ABR          || 標準エリア、バックボーンエリア、スタブエリア ||
||  4      || ASBR集約リンク     || O IA  || ABR          || 標準エリア、バックボーンエリア               ||
||  5      || AS外部リンク       || O Ex  || ASBR         || 標準エリア、バックボーンエリア               ||
||  7      || NSSAリンク         || O Nx  || NSSA内のASBR || NSSAエリア内                                 ||

!! LSAシーケンス
* 30分間隔でLLSUをフラッディング
* リンクステートエントリが60分いないにアップデートされない場合、シーケンス番号がLSDBから削除される
* シーケンス番号は0x80000001~0x7fffffff

!! エリア
!!!エリア分割のメリット
* オーバーヘッドの現象
* ルーティングテーブルサイズの縮小
* SPF計算頻度の減少


!! 主なマルティキャストアドレス
||! マルチキャストアドレス ||! 対象                  ||
|| 224.0.0.1               || サブネット上の全ホスト ||
|| 224.0.0.2               || サブネット上の全ルータ ||
|| 224.0.0.4               || DVMRPルータ            ||
|| 224.0.0.5               || OSPF ルータ            ||
|| 224.0.0.6               || OSPF DRとBDR           ||
|| 224.0.0.9               || RIPv2 ルータ           ||
|| 224.0.0.10              || EIGRPルータ            ||

!! コスト
 コスト = 100Mbps/インタフェースの帯域幅(bps)

!!! コスト計算式の分母の変更
 (config-router)# auto-cost reference-bandwidth <ref-bw>

!!! インタフェースコストの明示的指定
 (config-if)# ip ospf cost <cost> 

!! OSPF認証
: type0:
:: NULL認証
: type1:
:: プレーンテキスト認証
: type2:
:: MD5認証

!!! NBMA
!! NBMAネットワークの動作モード

||! 動作モード      ||! 推奨トポロジ ||! 実装 ||! 隣接関係 ||! DR/BDR選出 ||! Hello/Dead間隔 ||! 入力コマンド ||
|| MBMA             || フルメッシュ  || RFC   || 手動      || する        || 30秒/120秒      || non-broadcast ||
|| ブロードキャスト || フルメッシュ  || Cisco || 自動      || する        || 10秒/40秒       || broadcast     ||
|| ポイントツーマルティポイント || パーシャルメッシュまたはスター型 || RFC || 自動 || しない || 30秒/120秒 || point-to multi-point ||
|| ポイントツーマルティポイント ノンブロードキャスト || パーシャルメッシュまたはスター型 || Cisco || 手動 || しない || 30秒/120秒 || point-to multi-point non-broadcast ||
|| ポイントツーポイント ||  パーシャルメッシュまたはスター型 || Cisco || 自動 || しない || 10秒/40秒 || point-to-point ||


!! 設定
!!! ASBR上で経路集約
 (config-router)# summary-address <address> <subnet>

!!! ABR上で経路集約
 (config-router)# area <area> range <address> <subnet>

!!! 仮想リンク
 (config-router)# area <area> virtual-link <router-id>

* エリアIDには通過するエリアのエリアIDを指定する。
* ルータIDにはバーチャルリンクの相手側（出口側）のルータIDを指定する。

!!! OSPFエリアにデフォルトルートを通知
 (config-router)# default-information originate {always}

* ルーティングテーブルにデフォルトルートが内場合alwaysオプションをつける

!!! スタブエリアに設定
 (config-router)# area <area-id> stub

!!! トータリースタブエリアに設定
 (config-router)# area <area-id> stub no-summary

!!! NSSAエリアに設定
 (config-router)# area <area-id> nssa

!!! NSSAのトータリースタブエリアに設定
 (config-router)# area <area-id> nssa no-summary

!!! スタブエリアに通知するデフォルトルートのコストを設定
 (config-router)# area <area> default-cost <cos>

!!! 再配布
!!!! 他エリアに経路を再配布
 (config-router)# area <area> range <ip address> <subnet>


!!! プレーンテキスト認証の設定
 (config-router) area <area-id> authentication      ! ← OSPF認証をエリア単位で有効にする

 (config-if)# ip ospf authentication                ! ← OSPF認証を有効にする
 (config-if)# ip ospf authentication-key <password> ! ← パスワードを割り当てる

* パスワードはI/F単位で設定する。
* パスワードは8文字以内
* keyとパスワードは両端のI/Fで一致している必要がある

!! 設定確認
!!! ABRやASBRへの経路確認
 # show ip ospf border-router
